<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Analytics</title>
        <!-- Top Nav bar CSS styles -->
        <link
        rel="stylesheet" href="/Assets/css/navbar.css?version=4">
        <!-- File Specific CSS Styles -->
        <link
        rel="stylesheet" href="/Assets/css/SpArenaManager/manage-analytics.css?version=8">
        <link rel="stylesheet" href="/Assets/css/SpArenaManager/sidebar.css?version=10">
        <!-- Manifest file -->
        <link
        rel="manifest" href="/./manifest.json"/>
        <!-- File icons -->
        <script src="https://kit.fontawesome.com/3220c9480a.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>

    <body>
        <!-- Top Navigation Bar -->
        <nav>
            <div class="nav-left">
                <div class="logo-container">
                    <a href="/">
                        <i class="fas fa-running "></i>
                        <span class="logo-name">Sportizza</span>
                    </a>
                </div>

                <div
                    class="nav-right">
                    <!-- Profile button -->
                    <div class="nav-profile">
                        <button class="openbutton" onclick="openpopupform()">
                            <div class="profile-details">
                                <img src={{ current_user.profile_pic }} class="profile-picture">
                                <div class="username">{{ current_user.first_name }}
                                    {{ current_user.last_name }}</div>
                            </div>
                        </button>
                    </div>

                    <!-- Signout button -->
                    <div class="sign-in-out-btn">
                        <button onclick="open_popup_signout_message()">Sign Out</button>
                        <!-- {% if session.user_id %}
                                        User with ID {{session.user_id}} is logged in.
                                    {% endif %} -->
                    </div>
                </div>
            </div>
        </nav>

        <!-- start popup for profile -->
        <div id="myForm" class="sectionpopnav">
            <div class="formsectionprofile" id="formEditUserProfile">
                <div>
                    <button class="closebutton" onclick="closepopupform()">❌</button>
                </div>

                <div class="nav-user-edit-from">
                    <div class="details">
                        <div class="input-box">
                            <h5>Name:</h5>
                            <p>
                                {{ current_user.first_name }}
                                {{ current_user.last_name }}
                            </p>
                        </div>
                        <div class="input-box">
                            <h5>Username:</h5>
                            <p>
                                {{ current_user.username }}
                            </p>
                        </div>
                        <div class="input-box">
                            <h5>Mobile:</h5>
                            <p>
                                {{ current_user.primary_contact }}</p>
                        </div>
                    </div>
                    <div class="editProPic">
                        <img src={{ current_user.profile_pic }} id="form-profile-picture" alt="">
                    </div>
                </div>
                <div class="edit-profile-link">
                    <a href="\Edituserdetails\EditProfileAction">Edit Profile</a>
                </div>
            </div>
        </div>
        <!-- end popup for profile -->

        <!-- start pop up sign out section -->
        <div id="popup_signout" class="sectionpopnav">
            <div class="formsectionnav">
                <div>
                    <button class="closebutton" onclick="close_popup_signout_message()">❌</button>
                </div>
                <form action="/action_page.php" style="margin:20px">
                    <div style="margin:auto">
                        <h1>Sign Out</h1>
                        <p>Do your really want to sign out now?</p>
                    </div>
                </form>
                <div style="display:flex">
                    <button class="popup_buttonnav">
                        {% if current_user %}
                            <a href="/logout">
                                YES</a>
                        {% endif %}
                    </button>
                    <button onclick="close_popup_signout_message()" class="popup_delete_buttonnav">
                        NO
                    </button>
                </div>
            </div>
        </div>
        <!-- end pop up sign out section -->

        <!-- End Top Navigation Bar -->


        <section
            class="page-container">

            <!-- SIDE NAVIGATION BAR - START -->
            <div class="sidebar">
                <div class="sidebar-container">
                    <div class="side-menu">
                        <i class="fas fa-bars fa-2x " id="side-menu-open-btn"></i>
                        <i class="fas fa-times fa-2x" id="side-menu-close-btn"></i>
                    </div>
                    <ul class="side-menu-list">
                        <li>
                            <a href="/Sparenamanager" class="side-menu-li">
                                <i class="fas fa-home"></i>
                                <p class="side-menu-item">Arena Profile</p>
                            </a>
                            <p class="side-menu-tooltip">Arena Profile</p>
                        </li>
                        <li>
                            <a href="/Sparenamanager/managebookings" class="side-menu-li">
                                <i class="fas fa-bookmark"></i>
                                <p class="side-menu-item">Manage Bookings</p>
                            </a>
                            <p class="side-menu-tooltip">Bookings</p>
                        </li>
                        <li>
                            <a href="/Sparenamanager/managernotification" class="side-menu-li">
                                <i class="fas fa-bell"></i>
                                <span class="badge">{{notificationsCount}}</span>
                                <p class="side-menu-item">Notifications</p>
                            </a>
                            <p class="side-menu-tooltip">Notifications</p>
                        </li>
                        <li>
                            <a href="/Sparenamanager/managetimeslot" class="side-menu-li">
                                <i class="fas fa-clock"></i>
                                <p class="side-menu-item">Manage Timeslot</p>
                            </a>
                            <p class="side-menu-tooltip">Timeslot</p>
                        </li>
                        <li>
                            <a href="/Sparenamanager/managefacility" class="side-menu-li">
                                <i class="fas fa-building"></i>
                                <p class="side-menu-item">Manage Facility</p>
                            </a>
                            <p class="side-menu-tooltip">Facility</p>
                        </li>

                        <li>
                            <a href="/Sparenamanager/manageusers" class="side-menu-li">
                                <i class="fas fa-users"></i>
                                <p class="side-menu-item">Manage Staff</p>
                            </a>
                            <p class="side-menu-tooltip">Manage Staff</p>
                        </li>
                        <li>
                            <a href="/Sparenamanager/manageanalytics" class="side-menu-li">
                                <i class="fas fa-chart-bar"></i>
                                <p class="side-menu-item">Analytics</p>
                            </a>
                            <p class="side-menu-tooltip">Analytics</p>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- SIDE NAVIGATION BAR - END -->

            <!-- Analytics Page -->
            <div class="page-content-container">
                <div
                    class="container">

                    <!-- Download manager analytics section - start -->
                    <h2 class="doc-header">Sportizza</h2>
                    <h3 class="doc-sub-header">Analytics for
                        <span>{{ arenaName[0].sa_name }}</span>
                    </h3>
                    <h4 class="doc-date-header" id="date-header"></h4>
                    <h1 class="page-header">Analytics</h1>
                    <!-- Download manager analytics section - end -->

                    <!-- Date range filters -->
                    <div class="filters">
                        <div class="booking-table-date-picker" style="margin-top:5px;">
                            <label class="date-label" style="margin:5px;">Date Range
                            </label>
                            <select id="analyticsDateFilter" onchange="filterdata()">
                                <option value="12">Last 12 months</option>
                                <option value="6">Last 6 months</option>
                                <option value="3">Last 3 months</option>
                                <option value="1">Last month</option>
                            </select>
                        </div>
                        <!-- <div class="booking-table-date-picker" style="margin-top:5px;">
                                                <label class="date-label">End Date</label>
                                                <input type="date" style="border:1px solid #d3d3d3;border-radius:25px;padding:12px 20px;">
                                            </div> -->
                        <!-- <div class="booking-table-date-picker" style="margin-top:5px;">
                                                <input type="submit" value="Generate" class="report-generate">
                                            </div> -->
                    </div>
                    <div class="chart-container">
                        <div class="chart-row">
                            <div class="chart">
                                <h5>Booking Analytics</h5>
                                <canvas id="myChart1"></canvas>
                            </div>
                            <div class="chart-pie">
                                <h5>Payment Analytics</h5>
                                <canvas id="myChart2"></canvas>
                            </div>
                        </div>
                        <div class="chart-row">
                            <div class="chart">
                                <h5>Timeslots Analysis</h5>
                                <canvas id="myChart3"></canvas>
                            </div>
                            <div class="chart-pie">
                                <h5>Facility Analysis</h5>
                                <canvas id="myChart4"></canvas>
                            </div>
                        </div>

                    </div>


                    <button id="downloadPdf" class="faqSubmit">Download</button>


                </div>
            </div>
        </section>

        <!-- Start of Footer -->
        <footer>
            <div class="copyright">
                <p>
                    Copyright &copy;2021 All rights reserved | Sportizza Inc.
                </p>
            </div>
        </footer>
        <!-- End of Footer -->

        <script type="text/javascript" src="/Assets/js/lib/jquery/jquery.min.js"></script>
        <script type="text/javascript" src="/Assets/js/SpArenaManager/manage-analytics.js?version=2"></script>
        <script type="text/javascript" src="/Assets/js/SpArenaManager/manager-analytics-Pie-Ajax.js"></script>
        <!-- Service Worker -->
        <!-- <script src="/Assets/js/swSnippet.js"></script>
            <script src="/service-worker.js"></script> -->


        <script>
            var delayed;

            var ctx1 = document.getElementById('myChart1').getContext('2d');
            var myChart1 = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: [{% for chart in chart1 %}
                            '{{ chart.Time_Booked }}',{% endfor %}],
                    datasets: [
                        {
                            label: 'No of Bookings',
                            data: [{% for chart in chart1 %}
                                    {{ chart.No_Of_Bookings }},{% endfor %}],
                            backgroundColor: ['#ee5253'],
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    animation: { // delay: 500, // change delay to suit your needs.
                        onComplete: () => {
                            delayed = true;
                        },
                        delay: (context) => {
                            let delay = 0;
                            if (context.type === 'data' && context.mode === 'default' && ! delayed) {
                                delay = context.dataIndex * 300 + context.datasetIndex * 100;
                            }
                            return delay;
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#fff'
                            },
                            min: 0,

                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: '#fff'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            var ctx2 = document.getElementById('myChart2').getContext('2d');
            var myChart2 = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: [{% for chart in chart2 %}
                            '{{ chart.payment_method }}',{% endfor %}],
                    datasets: [
                        {
                            label: '# of Votes',
                            data: [{% for chart in chart2 %}
                                    {{ chart.No_Of_Bookings }},{% endfor %}],
                            backgroundColor: [
                                "#55E6C1", "#273c75",
                            ],
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { // delay: 500, // change delay to suit your needs.
                        onComplete: () => {
                            delayed = true;
                        },
                        delay: (context) => {
                            let delay = 0;
                            if (context.type === 'data' && context.mode === 'default' && ! delayed) {
                                delay = context.dataIndex * 300 + context.datasetIndex * 100;
                            }
                            return delay;
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            var ctx3 = document.getElementById('myChart3').getContext('2d');
            var myChart3 = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: [{% for chart in chart3 %}
                            '{{ chart.start_time }}',{% endfor %}],
                    datasets: [
                        {
                            label: 'No of Bookings',
                            data: [{% for chart in chart3 %}
                                    {{ chart.No_Of_Bookings }},{% endfor %}],
                            backgroundColor: ['#82589F'],
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    animation: { // delay: 500, // change delay to suit your needs.
                        onComplete: () => {
                            delayed = true;
                        },
                        delay: (context) => {
                            let delay = 0;
                            if (context.type === 'data' && context.mode === 'default' && ! delayed) {
                                delay = context.dataIndex * 300 + context.datasetIndex * 100;
                            }
                            return delay;
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#fff'
                            },
                            min: 0,

                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: '#fff'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            var ctx4 = document.getElementById('myChart4').getContext('2d');
            var myChart4 = new Chart(ctx4, {
                type: 'pie',
                data: {
                    labels: [{% for chart in chart4 %}
                            '{{ chart.facility_name }}',{% endfor %}],
                    datasets: [
                        {
                            label: '# of Votes',
                            data: [{% for chart in chart4 %}
                                    {{ chart.No_Of_Bookings }},{% endfor %}],
                            backgroundColor: [
                                "#e58e26", "#fad390", '#fa983a',
                            ],
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { // delay: 500, // change delay to suit your needs.
                        onComplete: () => {
                            delayed = true;
                        },
                        delay: (context) => {
                            let delay = 0;
                            if (context.type === 'data' && context.mode === 'default' && ! delayed) {
                                delay = context.dataIndex * 300 + context.datasetIndex * 100;
                            }
                            return delay;
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        </script>
        <script type="text/javascript">
            document.getElementById('downloadPdf').addEventListener('click', () => window.print())
        </script>

        <script type="text/javascript">
            // DATE RANGE CALCULATOR
            // INITIAL DATE RANGE
            var date = new Date();
            var today = date.toDateString().split(' ').slice(1).join(' ');

            var calculatedDate = date.setFullYear(date.getFullYear() - 1);
            calculatedDate = new Date(calculatedDate);
            calculatedDate = calculatedDate.toDateString().split(' ').slice(1).join(' ');
            document.getElementById('date-header').innerHTML = "From " + calculatedDate + " to " + today;

            // FIXED VALUES OF CHART 1 AXES
            const xaxis1 = myChart1.config.data.labels;
            const yaxis1 = myChart1.config.data.datasets[0].data;

            // FIXED VALUES OF CHART 3 AXES
            const xaxis3 = myChart3.config.data.labels;
            const yaxis3 = myChart3.config.data.datasets[0].data;

            function filterdata() {
                var dateValue = document.getElementById("analyticsDateFilter").value;

                // DATE RANGE UPDATE
                const curr_date = new Date();

                if (dateValue == 6) {
                    calculatedDate = curr_date.setMonth(curr_date.getMonth() - 6);
                } else if (dateValue == 3) {
                    calculatedDate = curr_date.setMonth(curr_date.getMonth() - 3);
                } else if (dateValue == 1) {
                    calculatedDate = curr_date.setMonth(curr_date.getMonth() - 1);
                } else {
                    calculatedDate = curr_date.setFullYear(curr_date.getFullYear() - 1);
                } calculatedDate = new Date(calculatedDate);
                calculatedDate = calculatedDate.toDateString().split(' ').slice(1).join(' ');
                document.getElementById('date-header').innerHTML = "From " + calculatedDate + " to " + today;

                // CHART 1 UPDATE
                var lastIndex1 = xaxis1.length - 1;

                var filterxaxis1 = xaxis1.slice(0, dateValue);
                var filteryaxis1 = yaxis1.slice(0, dateValue);

                if (dateValue != 0 && dateValue <= xaxis1.length) {
                    console.log(filterxaxis1);
                    console.log(filteryaxis1);
                    myChart1.config.data.labels = filterxaxis1;
                    myChart1.config.data.datasets[0].data = filteryaxis1;
                    myChart1.update();
                } else {
                    console.log(xaxis1);
                    console.log(yaxis1);
                    myChart1.config.data.labels = xaxis1;
                    myChart1.config.data.datasets[0].data = yaxis1;
                    myChart1.update();
                }

                // // CHART 3 UPDATE
                // var lastIndex3 = xaxis3.length -1;

                // var filterxaxis3 = xaxis3.slice(lastIndex3-dateValue+1);
                // var filteryaxis3 = yaxis3.slice(lastIndex3-dateValue+1);

                // if (dateValue!=0 && dateValue<=xaxis3.length){
                //     console.log(filterxaxis3);
                //     console.log(filteryaxis3);
                //     myChart3.config.data.labels = filterxaxis3;
                //     myChart3.config.data.datasets[0].data = filteryaxis3;
                //     myChart3.update();
                // }else{
                //     console.log(xaxis3);
                //     console.log(yaxis3);
                //     myChart3.config.data.labels = xaxis3;
                //     myChart3.config.data.datasets[0].data = yaxis3;
                //     myChart3.update();
                // }
            }
        </script>

        <!-- Top navbar js -->
        <script type="text/javascript" src="/Assets/js/navbar.js?v=8"></script>

    </body>

</html>
